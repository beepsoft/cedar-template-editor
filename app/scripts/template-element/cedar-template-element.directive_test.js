'use strict';

define(['app', 'angular'], function (app) {

  describe('cedar-template-element.directive_test.js:', function () {

    var $rootScope;
    var $compile;
    var $controller; // responsible for instantiating controllers
    var $httpBackend;
    var $templateCache;



    var DataManipulationService;
    var StagingService;
    var TemplateElementService;
    var DataUtilService;
    var SpreadsheetService;
    var UIUtilService;

    var createdTemplate;
    var createdModel;
    var createdTemplateElement;



    // Load the module that contains the templates that were loaded with html2js
    beforeEach(module('my.templates'));
    // Load other modules
    beforeEach(module(app.name));
    beforeEach(module('cedar.templateEditor.template.createTemplateController'));
    beforeEach(module('cedar.templateEditor.templateElement.createElementController'));
    beforeEach(module('cedar.templateEditor.templateElement.cedarTemplateElementDirective'));
    beforeEach(module('cedar.templateEditor.form.fieldDirective'));
    beforeEach(module('cedar.templateEditor.service.stagingService'));
    beforeEach(module('cedar.templateEditor.service.dataManipulationService'));
    beforeEach(module('cedar.templateEditor.service.dataUtilService'));
    beforeEach(module('cedar.templateEditor.form.spreadsheetService'));
    beforeEach(module('cedar.templateEditor.service.uIUtilService'));
    beforeEach(module('cedar.templateEditor.service.templateElementService'));


    // Mock the controlledTermDirectiveControlled because we don't need it for these tests
    beforeEach(function () {
      module('cedar.templateEditor.controlledTerm.controlledTermDirectiveController',
          function ($provide, $controllerProvider) {
            $controllerProvider.register('controlledTermDirectiveController', function ($scope) {
              // empty controller
            });
          });
    });


    beforeEach(inject(
        function (_$rootScope_, _$compile_, _$controller_, _$httpBackend_, _$templateCache_,
                  _StagingService_, _DataManipulationService_, _DataUtilService_, _SpreadsheetService_, _UIUtilService_,
                  _TemplateElementService_) {
          $rootScope = _$rootScope_.$new(); // create new scope
          $compile = _$compile_;
          $controller = _$controller_;
          $httpBackend = _$httpBackend_;
          $templateCache = _$templateCache_;

          StagingService = _StagingService_;
          DataManipulationService = _DataManipulationService_;
          DataUtilService = _DataUtilService_;
          SpreadsheetService = _SpreadsheetService_;
          UIUtilService = _UIUtilService_;
          TemplateElementService = _TemplateElementService_;

        }));

    beforeEach(function () {
      // returns the appropriate file content when requested
      $httpBackend.whenGET('resources/i18n/locale-en.json').respond(function (method, url, data) {
        var request = new XMLHttpRequest();
        request.open('GET', 'resources/i18n/locale-en.json', false);
        request.send(null);
        return [request.status, request.response, {}];
      });


      $httpBackend.whenGET(
          'https://resource.metadatacenter.orgx/template-elements/https%3A%2F%2Frepo.metadatacenter.orgx%2Ftemplate-elements%2F7ce9f613-ff0b-427b-a007-4d3b0cbe1fbb').respond(
          function (method, url, data) {
            var data = {
              "@id"                 : "https://repo.metadatacenter.orgx/template-elements/7ce9f613-ff0b-427b-a007-4d3b0cbe1fbb",
              "@type"               : "https://schema.metadatacenter.org/core/TemplateElement",
              "@context"            : {
                "xsd"              : "http://www.w3.org/2001/XMLSchema#",
                "pav"              : "http://purl.org/pav/",
                "oslc"             : "http://open-services.net/ns/core#",
                "schema"           : "http://schema.org/",
                "pav:createdOn"    : {
                  "@type": "xsd:dateTime"
                },
                "pav:createdBy"    : {
                  "@type": "@id"
                },
                "pav:lastUpdatedOn": {
                  "@type": "xsd:dateTime"
                },
                "oslc:modifiedBy"  : {
                  "@type": "@id"
                }
              },
              "type"                : "object",
              "title"               : "Test element schema",
              "description"         : "Test element schema autogenerated by the CEDAR Template Editor 1.0.7-SNAPSHOT",
              "_ui"                 : {
                "title"         : "test",
                "description"   : "Description",
                "order"         : [],
                "propertyLabels": {}
              },
              "properties"          : {
                "@context"         : {
                  "type"                : "object",
                  "properties"          : {
                    "pav" : {
                      "type"  : "string",
                      "format": "uri",
                      "enum"  : [
                        "http://purl.org/pav/"
                      ]
                    },
                    "oslc": {
                      "type"  : "string",
                      "format": "uri",
                      "enum"  : [
                        "http://open-services.net/ns/core#"
                      ]
                    }
                  },
                  "patternProperties"   : {
                    "^(?!pav)(?!schema)(?!oslc)[a-zA-Z][a-zA-Z0-9]*$": {
                      "type"  : "string",
                      "format": "uri"
                    }
                  },
                  "required"            : [],
                  "additionalProperties": false
                },
                "@id"              : {
                  "type"  : [
                    "string",
                    "null"
                  ],
                  "format": "uri"
                },
                "@type"            : {
                  "oneOf": [
                    {
                      "type"  : "string",
                      "format": "uri"
                    },
                    {
                      "type"       : "array",
                      "minItems"   : 1,
                      "items"      : {
                        "type"  : "string",
                        "format": "uri"
                      },
                      "uniqueItems": true
                    }
                  ]
                },
                "pav:createdOn"    : {
                  "type"  : [
                    "string",
                    "null"
                  ],
                  "format": "date-time"
                },
                "pav:createdBy"    : {
                  "type"  : [
                    "string",
                    "null"
                  ],
                  "format": "uri"
                },
                "pav:lastUpdatedOn": {
                  "type"  : [
                    "string",
                    "null"
                  ],
                  "format": "date-time"
                },
                "oslc:modifiedBy"  : {
                  "type"  : [
                    "string",
                    "null"
                  ],
                  "format": "uri"
                }
              },
              "required"            : [
                "@context"
              ],
              "pav:createdOn"       : "2017-05-30T14:15:52-0700",
              "pav:createdBy"       : "https://metadatacenter.org/users/287aef81-b87c-4278-9c40-5f3d464c5b30",
              "pav:lastUpdatedOn"   : "2017-05-30T14:15:52-0700",
              "oslc:modifiedBy"     : "https://metadatacenter.org/users/287aef81-b87c-4278-9c40-5f3d464c5b30",
              "schema:schemaVersion": "1.1.0",
              "additionalProperties": false,
              "$schema"             : "http://json-schema.org/draft-04/schema#"
            };
            var newElement = angular.fromJson(data);
            return [200, data, {}];
          });


    });


    // add an element to a template, then test
    describe('In a template,', function () {
      describe(' add an element', function () {

        var $cedarTemplateElementScope;
        var $createTemplateControllerScope;
        var cedarTemplateElementDirective;
        var compiledDirective;
        var clonedElement;

        beforeEach(function () {

          // create a templateController scope
          $createTemplateControllerScope = $rootScope.$new(true) ;
          // Initialize the CreateTemplateController
          $controller('CreateTemplateController', {
            $rootScope: $rootScope,
            $scope    : $createTemplateControllerScope
          });

          // create a templateElement scope
          $cedarTemplateElementScope = $rootScope.$new(true);
          var domId = DataManipulationService.createDomId();
          var callback = function () {
          };

          // Create the element and add it to the template
          clonedElement = {
            "@id"                 : "https://repo.metadatacenter.orgx/template-elements/7ce9f613-ff0b-427b-a007-4d3b0cbe1fbb",
            "@type"               : "https://schema.metadatacenter.org/core/TemplateElement",
            "@context"            : {
              "xsd"              : "http://www.w3.org/2001/XMLSchema#",
              "pav"              : "http://purl.org/pav/",
              "oslc"             : "http://open-services.net/ns/core#",
              "schema"           : "http://schema.org/",
              "pav:createdOn"    : {
                "@type": "xsd:dateTime"
              },
              "pav:createdBy"    : {
                "@type": "@id"
              },
              "pav:lastUpdatedOn": {
                "@type": "xsd:dateTime"
              },
              "oslc:modifiedBy"  : {
                "@type": "@id"
              }
            },
            "type"                : "object",
            "title"               : "Test element schema",
            "description"         : "Test element schema autogenerated by the CEDAR Template Editor 1.0.7-SNAPSHOT",
            "_ui"                 : {
              "title"         : "test",
              "description"   : "Description",
              "order"         : [],
              "propertyLabels": {}
            },
            "properties"          : {
              "@context"         : {
                "type"                : "object",
                "properties"          : {
                  "pav" : {
                    "type"  : "string",
                    "format": "uri",
                    "enum"  : [
                      "http://purl.org/pav/"
                    ]
                  },
                  "oslc": {
                    "type"  : "string",
                    "format": "uri",
                    "enum"  : [
                      "http://open-services.net/ns/core#"
                    ]
                  }
                },
                "patternProperties"   : {
                  "^(?!pav)(?!schema)(?!oslc)[a-zA-Z][a-zA-Z0-9]*$": {
                    "type"  : "string",
                    "format": "uri"
                  }
                },
                "required"            : [],
                "additionalProperties": false
              },
              "@id"              : {
                "type"  : [
                  "string",
                  "null"
                ],
                "format": "uri"
              },
              "@type"            : {
                "oneOf": [
                  {
                    "type"  : "string",
                    "format": "uri"
                  },
                  {
                    "type"       : "array",
                    "minItems"   : 1,
                    "items"      : {
                      "type"  : "string",
                      "format": "uri"
                    },
                    "uniqueItems": true
                  }
                ]
              },
              "pav:createdOn"    : {
                "type"  : [
                  "string",
                  "null"
                ],
                "format": "date-time"
              },
              "pav:createdBy"    : {
                "type"  : [
                  "string",
                  "null"
                ],
                "format": "uri"
              },
              "pav:lastUpdatedOn": {
                "type"  : [
                  "string",
                  "null"
                ],
                "format": "date-time"
              },
              "oslc:modifiedBy"  : {
                "type"  : [
                  "string",
                  "null"
                ],
                "format": "uri"
              }
            },
            "required"            : [
              "@context"
            ],
            "pav:createdOn"       : "2017-05-30T14:15:52-0700",
            "pav:createdBy"       : "https://metadatacenter.org/users/287aef81-b87c-4278-9c40-5f3d464c5b30",
            "pav:lastUpdatedOn"   : "2017-05-30T14:15:52-0700",
            "oslc:modifiedBy"     : "https://metadatacenter.org/users/287aef81-b87c-4278-9c40-5f3d464c5b30",
            "schema:schemaVersion": "1.1.0",
            "additionalProperties": false,
            "$schema"             : "http://json-schema.org/draft-04/schema#"
          };
          $cedarTemplateElementScope.element = StagingService.addClonedElementToForm($createTemplateControllerScope.form, elementId, clonedElement, domId, callback);
          var elementId = $cedarTemplateElementScope.element['@id'];

          // Compile field directive
          cedarTemplateElementDirective = "<cedar-template-element  element='element' model='model'> </cedar-template-element>";
          compiledDirective = $compile(cedarTemplateElementDirective)($cedarTemplateElementScope);

          // Now run a $digest cycle
          $cedarTemplateElementScope.$digest();

        });

        it("should have one element ", function () {

          // should contain the cloned element
          expect(compiledDirective.isolateScope().element).toEqual(clonedElement);

          // should have an element-name-label
          var elm = compiledDirective[0];
          expect(elm.querySelector('.element-name-label')).toBeDefined();

        });
      });
    });


  });
});
